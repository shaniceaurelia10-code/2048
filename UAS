import curses
from random import choice, randint

def init_board():
    return [[0 for _ in range(4)] for _ in range(4)]   # papan 4x4

def add_new_tile(board):
    empty = [(r,c) for r in range(4) for c in range(4) if board[r][c]==0]  # bikin slot kosong
    if empty:
        r,c = choice(empty)
        board[r][c] = 4 if randint(1,10)==1 else 2     # muncul angka baru

def compress(row):
    nums = [x for x in row if x!=0]                    # geser angka ke kiri
    return nums + [0]*(4-len(nums))

def merge(row):
    for i in range(3):
        if row[i]!=0 and row[i]==row[i+1]:
            row[i] *= 2                                # gabung-gabungin angka
            row[i+1] = 0
    return row

def reverse(row):
    return row[::-1]                                   # balik baris

def transpose(board):
    return [list(x) for x in zip(*board)]              # tukar baris-kolom

def move_left(board):
    moved = False
    new = []
    for row in board:
        c = compress(row)
        m = merge(c)
        f = compress(m)                                # final setelah gabung
        new.append(f)
        if f != row: moved = True
    return new, moved

def move_right(board):
    rev = [reverse(r) for r in board]
    moved_board, moved = move_left(rev)
    return [reverse(r) for r in moved_board], moved

def move_up(board):
    t = transpose(board)
    moved_board, moved = move_left(t)
    return transpose(moved_board), moved

def move_down(board):
    t = transpose(board)
    moved_board, moved = move_right(t)
    return transpose(moved_board), moved

def can_move(board):
    if any(0 in row for row in board): return True     # masih ada yg kosong
    for r in range(4):
        for c in range(3):
            if board[r][c]==board[r][c+1]: return True # gabung horizontal
    for c in range(4):
        for r in range(3):
            if board[r][c]==board[r+1][c]: return True # gabung vertikal
    return False

def draw(stdscr, board, score):
    stdscr.clear()
    stdscr.addstr(0,0,"2048 (Curses) | WASD/Arrows | Q quit")
    stdscr.addstr(1,0,f"Score: {score}")
    stdscr.addstr(2,0,"-"*24)
    for r in range(4):
        s = ""
        for c in range(4):
            v = board[r][c]
            s += f"{v}".rjust(5) if v!=0 else "   . "
        stdscr.addstr(4+r, 0, s)
    stdscr.refresh()

def main(stdscr):
    curses.curs_set(0)
    board = init_board()
    score = 0
    add_new_tile(board); add_new_tile(board)

    while True:
        draw(stdscr, board, score)
        key = stdscr.getch()

        if key in (ord('q'), ord('Q')):
            break

        moves = {
            curses.KEY_LEFT: move_left,
            curses.KEY_RIGHT: move_right,
            curses.KEY_UP: move_up,
            curses.KEY_DOWN: move_down,
            ord('a'): move_left,
            ord('d'): move_right,
            ord('w'): move_up,
            ord('s'): move_down,
        }

        if key not in moves: 
            continue

        new_board, moved = moves[key](board)

        if moved:
            for r in range(4):
                for c in range(4):
                    if new_board[r][c] > board[r][c]:
                        score += new_board[r][c]        # nambah skor when merge
            board = new_board
            add_new_tile(board)

        if not can_move(board):
            draw(stdscr, board, score)
            stdscr.addstr(10,0,"GAME OVER!")
            stdscr.getch()
            break

if __name__ == "__main__":
    curses.wrapper(main)
